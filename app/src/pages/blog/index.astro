---
import { getPageBySlug } from "@/functions/wp-api";

import Page from "@/layouts/Page.astro";

const { slug } = Astro.params;

const page = await getPageBySlug("blog/");

if (!page) {
    return Astro.redirect("/404");
}

function normalizeLocalURLs(html: string): string {
    // 1️⃣ Decodificar entidades HTML (por si WordPress escapó las comillas o los :)
    const decoded = html
        .replaceAll(/&quot;/g, '"')
        .replaceAll(/&#x3A;/g, ":")
        .replaceAll(/&#039;/g, "'")
        .replaceAll(/&amp;/g, "&");

    // 2️⃣ Corregir URLs con puertos duplicados, como :4321:4321
    const fixed = decoded.replace(
        /(https?:\/\/(?:localhost|127\.0\.0\.1):\d+):\d+(\/[\w\-./?=#%&]*)/g,
        "$1$2",
    );

    // 3️⃣ Devolver HTML corregido
    return fixed;
}

const cleanContent = normalizeLocalURLs(page.content.rendered);
---

<Page content={page.content.rendered}>
    <article class="container min-h-32 flex flex-col items-start">
        <section class="grid place-content-center bg-orange-50 px-8 py-6 mt-12">
            <h1 class="text-4xl font-bold text-primary">
                {page.title.rendered}
            </h1>
        </section>
        <section class="w-4xl py-20 px-12">
            <div class="prose prose-lg max-w-none" set:html={cleanContent} />
        </section>
    </article>
</Page>

<style is:global>
    .wp-block-image img {
        margin: auto;
    }

    .wp-block-image {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .wp-block-columns {
        display: flex;
        gap: 2rem;
    }
</style>
